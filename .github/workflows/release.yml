name: Release

on:
  workflow_call:
    inputs:
      tag_name:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag name (e.g., v0.4.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: linux-amd64
            os: ubuntu-latest
            hub_bin: capydeploy-hub-tauri
            agent_bin: capydeploy-agent-tauri
          - target: windows-amd64
            os: windows-latest
            hub_bin: capydeploy-hub-tauri.exe
            agent_bin: capydeploy-agent-tauri.exe
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag_name }}

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: ". -> target"
          key: ${{ matrix.target }}

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev

      - uses: oven-sh/setup-bun@v2

      - name: Build frontends (required by tauri_build)
        shell: bash
        run: |
          cd apps/hub-tauri/frontend && bun install && bun run build && cd ../../..
          cd apps/agents/agent-tauri/frontend && bun install && bun run build && cd ../../..

      - name: Build binaries
        run: cargo build --release -p capydeploy-hub-tauri -p capydeploy-agent-tauri

      - name: Upload Hub binary
        uses: actions/upload-artifact@v4
        with:
          name: hub-${{ matrix.target }}
          path: target/release/${{ matrix.hub_bin }}

      - name: Upload Agent binary
        uses: actions/upload-artifact@v4
        with:
          name: agent-${{ matrix.target }}
          path: target/release/${{ matrix.agent_bin }}

  appimage:
    name: AppImage
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag_name }}

      - name: Download Hub Linux binary
        uses: actions/download-artifact@v4
        with:
          name: hub-linux-amd64
          path: artifacts/hub

      - name: Download Agent Linux binary
        uses: actions/download-artifact@v4
        with:
          name: agent-linux-amd64
          path: artifacts/agent

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libgdk-pixbuf2.0-bin

      - name: Download tools
        run: |
          curl -L -o appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          curl -L -o linuxdeploy https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x appimagetool linuxdeploy

      - name: Prepare AppDirs
        run: |
          generate_desktop() {
            local binary_name="$1"
            local display_name="$2"
            local desktop_id="$3"
            local output="$4"
            cat > "$output" << DESKTOP_EOF
          [Desktop Entry]
          Name=${display_name}
          Comment=Deploy games to Steam Deck and Linux devices
          Exec=${binary_name}
          Icon=${desktop_id}
          Type=Application
          Categories=Game;Development;
          Terminal=false
          DESKTOP_EOF
          }

          # Hub AppDir
          mkdir -p hub.AppDir/usr/bin
          cp artifacts/hub/capydeploy-hub-tauri hub.AppDir/usr/bin/
          chmod +x hub.AppDir/usr/bin/capydeploy-hub-tauri
          cp apps/hub-tauri/src-tauri/icons/icon.png hub.AppDir/capydeploy-hub.png
          generate_desktop "capydeploy-hub-tauri" "CapyDeploy Hub" "capydeploy-hub" "hub.AppDir/capydeploy-hub.desktop"

          # Agent AppDir
          mkdir -p agent.AppDir/usr/bin
          cp artifacts/agent/capydeploy-agent-tauri agent.AppDir/usr/bin/
          chmod +x agent.AppDir/usr/bin/capydeploy-agent-tauri
          cp apps/agents/agent-tauri/src-tauri/icons/icon.png agent.AppDir/capydeploy-agent.png
          generate_desktop "capydeploy-agent-tauri" "CapyDeploy Agent" "capydeploy-agent" "agent.AppDir/capydeploy-agent.desktop"

      - name: Bundle libraries
        env:
          APPIMAGE_EXTRACT_AND_RUN: "1"
        run: |
          # Bundle shared libraries with linuxdeploy
          ./linuxdeploy --appdir hub.AppDir \
            --executable hub.AppDir/usr/bin/capydeploy-hub-tauri \
            --desktop-file hub.AppDir/capydeploy-hub.desktop \
            --icon-file hub.AppDir/capydeploy-hub.png

          ./linuxdeploy --appdir agent.AppDir \
            --executable agent.AppDir/usr/bin/capydeploy-agent-tauri \
            --desktop-file agent.AppDir/capydeploy-agent.desktop \
            --icon-file agent.AppDir/capydeploy-agent.png

          # Bundle WebKit helper processes (not detected by ldd)
          WEBKIT_DIR=""
          for candidate in /usr/libexec/webkit2gtk-4.1 /usr/lib/x86_64-linux-gnu/webkit2gtk-4.1; do
            if [ -d "$candidate" ]; then
              WEBKIT_DIR="$candidate"
              break
            fi
          done
          # Fallback: find by binary location
          if [ -z "$WEBKIT_DIR" ]; then
            WKP=$(find /usr -name "WebKitWebProcess" -path "*webkit2gtk*" 2>/dev/null | head -1)
            if [ -n "$WKP" ]; then
              WEBKIT_DIR=$(dirname "$WKP")
            fi
          fi
          if [ -n "$WEBKIT_DIR" ]; then
            echo "Bundling WebKit helpers from $WEBKIT_DIR..."
            for appdir in hub.AppDir agent.AppDir; do
              mkdir -p "$appdir/usr/libexec/webkit2gtk-4.1"
              cp "$WEBKIT_DIR/WebKitWebProcess" "$appdir/usr/libexec/webkit2gtk-4.1/"
              cp "$WEBKIT_DIR/WebKitNetworkProcess" "$appdir/usr/libexec/webkit2gtk-4.1/"
            done
          else
            echo "::warning::WebKit helpers not found"
          fi

          # Bundle GLib compiled schemas
          if [ -f "/usr/share/glib-2.0/schemas/gschemas.compiled" ]; then
            echo "Bundling GLib schemas..."
            for appdir in hub.AppDir agent.AppDir; do
              mkdir -p "$appdir/usr/share/glib-2.0/schemas"
              cp /usr/share/glib-2.0/schemas/gschemas.compiled "$appdir/usr/share/glib-2.0/schemas/"
            done
          fi

          # Bundle GIO modules (TLS support)
          GIO_DIR=$(pkg-config --variable=giomoduledir gio-2.0 2>/dev/null || echo "/usr/lib/x86_64-linux-gnu/gio/modules")
          if [ -d "$GIO_DIR" ]; then
            echo "Bundling GIO modules from $GIO_DIR..."
            for appdir in hub.AppDir agent.AppDir; do
              mkdir -p "$appdir/usr/lib/gio/modules"
              cp "$GIO_DIR"/*.so "$appdir/usr/lib/gio/modules/"
            done
          fi

          # Bundle GDK pixbuf loaders
          PIXBUF_DIR="/usr/lib/x86_64-linux-gnu/gdk-pixbuf-2.0/2.10.0"
          if compgen -G "$PIXBUF_DIR/loaders/*.so" > /dev/null 2>&1; then
            echo "Bundling GDK pixbuf loaders..."
            for appdir in hub.AppDir agent.AppDir; do
              mkdir -p "$appdir/usr/lib/gdk-pixbuf-2.0/2.10.0/loaders"
              cp "$PIXBUF_DIR/loaders"/*.so "$appdir/usr/lib/gdk-pixbuf-2.0/2.10.0/loaders/"
              if command -v gdk-pixbuf-query-loaders &>/dev/null; then
                GDK_PIXBUF_MODULEDIR="$appdir/usr/lib/gdk-pixbuf-2.0/2.10.0/loaders" \
                  gdk-pixbuf-query-loaders > "$appdir/usr/lib/gdk-pixbuf-2.0/2.10.0/loaders.cache"
              fi
            done
          fi

      - name: Generate AppRun scripts
        run: |
          generate_apprun() {
            local binary_name="$1"
            local desktop_name="$2"
            local display_name="$3"
            local find_pattern="$4"
            local output="$5"
            cat > "$output" << APPRUN_EOF
          #!/bin/bash
          SELF=\$(readlink -f "\$0")
          HERE=\${SELF%/*}
          APPIMAGE="\${APPIMAGE:-\$SELF}"
          APP_NAME="${display_name}"
          BINARY_NAME="${binary_name}"
          DESKTOP_NAME="${desktop_name}"
          INSTALL_DIR="\$HOME/.local/bin"
          DESKTOP_DIR="\$HOME/.local/share/applications"
          ICON_DIR="\$HOME/.local/share/icons"

          # Bundled library paths
          export LD_LIBRARY_PATH="\${HERE}/usr/lib:\${LD_LIBRARY_PATH}"
          export WEBKIT_EXEC_PATH="\${HERE}/usr/libexec/webkit2gtk-4.1"
          export GIO_MODULE_DIR="\${HERE}/usr/lib/gio/modules"
          export GDK_PIXBUF_MODULE_FILE="\${HERE}/usr/lib/gdk-pixbuf-2.0/2.10.0/loaders.cache"
          export GSETTINGS_SCHEMA_DIR="\${HERE}/usr/share/glib-2.0/schemas"

          install_app() {
              echo "Installing \$APP_NAME..."
              mkdir -p "\$INSTALL_DIR" "\$DESKTOP_DIR" "\$ICON_DIR"
              DEST="\$INSTALL_DIR/\$(basename "\$APPIMAGE")"
              if [ "\$APPIMAGE" != "\$DEST" ]; then
                  mv "\$APPIMAGE" "\$DEST"
                  chmod +x "\$DEST"
                  echo "  Moved to: \$DEST"
              fi
              "\$DEST" --appimage-extract "\$DESKTOP_NAME.png" >/dev/null 2>&1
              if [ -f "squashfs-root/\$DESKTOP_NAME.png" ]; then
                  cp "squashfs-root/\$DESKTOP_NAME.png" "\$ICON_DIR/\$DESKTOP_NAME.png"
                  rm -rf squashfs-root
                  echo "  Icon installed"
              fi
              cat > "\$DESKTOP_DIR/\$DESKTOP_NAME.desktop" << INNER_DESKTOP
          [Desktop Entry]
          Name=${display_name}
          Comment=Deploy games to Steam Deck and Linux devices
          Exec=\$DEST --run
          Icon=\$ICON_DIR/\$DESKTOP_NAME.png
          Type=Application
          Categories=Game;Development;
          Terminal=false
          INNER_DESKTOP
              echo "  Desktop entry created"
              echo ""
              echo "Installation complete! You can find the app in your application menu."
          }

          uninstall_app() {
              echo "Uninstalling \$APP_NAME..."
              find "\$INSTALL_DIR" -maxdepth 1 -iname "${find_pattern}" -delete 2>/dev/null
              rm -f "\$DESKTOP_DIR/\$DESKTOP_NAME.desktop"
              rm -f "\$ICON_DIR/\$DESKTOP_NAME.png"
              echo "Uninstalled."
          }

          case "\$1" in
              --install)
                  install_app
                  exit 0
                  ;;
              --uninstall)
                  uninstall_app
                  exit 0
                  ;;
              --run)
                  shift
                  export PATH="\${HERE}/usr/bin:\${PATH}"
                  exec "\${HERE}/usr/bin/${binary_name}" "\$@"
                  ;;
              --help)
                  echo "Usage: \$(basename "\$APPIMAGE") [OPTIONS]"
                  echo ""
                  echo "Options:"
                  echo "  --install     Install to ~/.local/bin and create desktop entry"
                  echo "  --uninstall   Remove installation"
                  echo "  --run         Run without install check (used by .desktop)"
                  echo "  --help        Show this help"
                  exit 0
                  ;;
          esac

          if [[ "\$APPIMAGE" != "\$INSTALL_DIR"/* ]] && [ ! -t 0 ]; then
              if command -v zenity &>/dev/null; then
                  if zenity --question --title="Install \$APP_NAME" \
                      --text="Install to ~/.local/bin and create menu entry?" \
                      --width=300 2>/dev/null; then
                      install_app
                      exec "\$INSTALL_DIR/\$(basename "\$APPIMAGE")" --run "\$@"
                  fi
              elif command -v kdialog &>/dev/null; then
                  if kdialog --yesno "Install to ~/.local/bin and create menu entry?" \
                      --title "Install \$APP_NAME" 2>/dev/null; then
                      install_app
                      exec "\$INSTALL_DIR/\$(basename "\$APPIMAGE")" --run "\$@"
                  fi
              fi
          fi

          export PATH="\${HERE}/usr/bin:\${PATH}"
          exec "\${HERE}/usr/bin/${binary_name}" "\$@"
          APPRUN_EOF
            chmod +x "$output"
          }

          generate_apprun "capydeploy-hub-tauri" "capydeploy-hub" "CapyDeploy Hub" "*capydeploy*hub*.AppImage" "hub.AppDir/AppRun"
          generate_apprun "capydeploy-agent-tauri" "capydeploy-agent" "CapyDeploy Agent" "*capydeploy*agent*.AppImage" "agent.AppDir/AppRun"

      - name: Build AppImages
        env:
          APPIMAGE_EXTRACT_AND_RUN: "1"
        run: |
          ARCH=x86_64 ./appimagetool hub.AppDir CapyDeploy_Hub.AppImage
          ARCH=x86_64 ./appimagetool agent.AppDir CapyDeploy_Agent.AppImage

      - name: Upload AppImages
        uses: actions/upload-artifact@v4
        with:
          name: appimages
          path: |
            CapyDeploy_Hub.AppImage
            CapyDeploy_Agent.AppImage

  upload-assets:
    name: Upload Release Assets
    needs: [build, appimage]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag_name }}
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Package release assets
        run: |
          mkdir -p release

          # Linux tar.gz
          mkdir -p staging/linux
          cp artifacts/hub-linux-amd64/capydeploy-hub-tauri staging/linux/
          cp artifacts/agent-linux-amd64/capydeploy-agent-tauri staging/linux/
          chmod +x staging/linux/*
          tar -czf "release/capydeploy-linux-amd64.tar.gz" -C staging/linux .

          # Windows zip
          mkdir -p staging/windows
          cp artifacts/hub-windows-amd64/capydeploy-hub-tauri.exe staging/windows/
          cp artifacts/agent-windows-amd64/capydeploy-agent-tauri.exe staging/windows/
          cd staging/windows && zip -r "../../release/capydeploy-windows-amd64.zip" . && cd ../..

          # AppImages
          cp artifacts/appimages/CapyDeploy_Hub.AppImage release/
          cp artifacts/appimages/CapyDeploy_Agent.AppImage release/
          chmod +x release/*.AppImage

          # Checksums
          cd release
          sha256sum * > checksums-sha256.txt

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag_name }}
          append_body: true
          body: |

            ## Downloads

            | File | Description |
            |------|-------------|
            | `capydeploy-linux-amd64.tar.gz` | Linux binaries (Hub + Agent) |
            | `capydeploy-windows-amd64.zip` | Windows binaries (Hub + Agent) |
            | `CapyDeploy_Hub.AppImage` | Hub AppImage (auto-install support) |
            | `CapyDeploy_Agent.AppImage` | Agent AppImage (auto-install support) |
            | `checksums-sha256.txt` | SHA-256 checksums for all files |
          files: release/*
          generate_release_notes: false
