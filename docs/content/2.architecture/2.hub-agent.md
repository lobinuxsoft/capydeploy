---
title: Hub-Agent Pattern
description: WebSocket protocol and communication details
icon: ph:plugs-connected-duotone
---

# Hub-Agent Pattern

Hub and Agent communicate over a **persistent WebSocket connection**.

## Connection

::alert{type="info"}
**Endpoint:** `ws://[agent-ip]:9999/ws`
::

The WebSocket channel handles:
- Handshake and authentication
- RPC-style requests/responses
- Binary chunk uploads
- Real-time progress events

## Discovery (mDNS)

Agent broadcasts its presence:

| Property | Value |
|----------|-------|
| Service | `_capydeploy._tcp.local` |
| Port | 9999 |
| TXT Records | id, name, version, platform |

Hub runs a Zeroconf client that listens for these broadcasts.

## Authentication Flow

### First Connection (Pairing)

::steps
### Hub sends handshake
`hub_connected` message with name, version, hubId (no token).

### Agent requires pairing
`pairing_required` response with 6-digit code (60 second TTL).

### User enters code
Hub sends `pair_confirm` with the code entered by user.

### Token issued
Agent validates code, sends `pair_success` with auth token.

### Token stored
Hub saves token locally for future connections.
::

### Subsequent Connections

::steps
### Hub sends handshake with token
`hub_connected` message includes stored token.

### Agent validates token
If valid, sends `agent_status`. Connection established.

### Ready for operations
All RPC calls now available.
::

## Message Format

All WebSocket messages use JSON:

```json
{
  "id": "unique-message-id",
  "type": "message_type",
  "payload": { ... },
  "error": { "code": 400, "message": "..." }
}
```

| Field | Description |
|-------|-------------|
| `id` | Unique ID for request/response correlation |
| `type` | Message type (see Protocol Types) |
| `payload` | Type-specific data |
| `error` | Present only on error responses |

## Binary Uploads

Large files are sent as binary WebSocket messages:

::steps
### Initialize upload
Hub sends `init_upload` with file manifest, total size, file list.

### Agent confirms
Responds with `upload_init_response`: uploadId, chunkSize (1MB default).

### Send binary chunks
Each chunk: JSON header (null-terminated) + raw binary data.

### Progress events
Agent pushes `upload_progress` after each chunk.

### Complete
Hub sends `complete_upload`. Agent creates shortcut if requested.
::

### Binary Chunk Format

```
[4-byte header length][JSON header][binary chunk data]
```

JSON header:
```json
{
  "id": "msg-id",
  "uploadId": "session-id",
  "filePath": "relative/path/to/file",
  "offset": 0,
  "checksum": "sha256..."
}
```

## Timing Constants

| Constant | Value | Description |
|----------|-------|-------------|
| Ping Period | 5s | Keep-alive interval |
| Pong Wait | 15s | Max wait for pong |
| Write Wait | 10s | Max write time |
| Request Timeout | 30s | RPC timeout |
| Max Message | 10MB | Max message size |
| Chunk Size | 1MB | Binary chunk size |
