---
title: WebSocket API
description: Primary communication protocol
icon: ph:lightning-duotone
---

# WebSocket API

::alert{type="success"}
**Primary Protocol.** All communication between Hub and Agent happens over WebSocket.
::

**Endpoint:** `ws://<agent-ip>:9999/ws`

## Message Format

All messages use JSON:

```json
{
  "id": "unique-id",
  "type": "message_type",
  "payload": { ... },
  "error": { "code": 400, "message": "..." }
}
```

## Connection & Authentication

### hub_connected
:badge[Hub → Agent]{type="warning"}

Initial handshake. Send on connect.

```json
{
  "name": "CapyDeploy Hub",
  "version": "0.1.0",
  "hubId": "hub-abc123",
  "token": "stored-token-or-empty"
}
```

### pairing_required
:badge[Agent → Hub]{type="info"}

Sent when Hub needs to pair (no valid token).

```json
{
  "code": "123456",
  "expiresIn": 60
}
```

### pair_confirm
:badge[Hub → Agent]{type="warning"}

User entered the pairing code.

```json
{ "code": "123456" }
```

### pair_success
:badge[Agent → Hub]{type="info"}

Pairing successful. Store this token.

```json
{ "token": "secure-auth-token..." }
```

### pair_failed
:badge[Agent → Hub]{type="danger"}

Pairing failed (invalid/expired code).

```json
{ "reason": "invalid code" }
```

### agent_status
:badge[Agent → Hub]{type="info"}

Sent after successful authentication.

```json
{
  "name": "Steam Deck",
  "version": "0.1.0",
  "platform": "linux",
  "acceptConnections": true
}
```

## RPC Messages

### ping / pong

Keep-alive. Hub sends every 5 seconds.

### get_info / info_response

Get Agent details and capabilities.

```json [Response payload]
{
  "agent": {
    "id": "agent-abc123",
    "name": "Steam Deck",
    "platform": "linux",
    "capabilities": ["file_upload", "steam_shortcuts", ...]
  }
}
```

### get_config / config_response

Get Agent configuration.

```json [Response payload]
{ "installPath": "/home/deck/Games" }
```

### get_steam_users / steam_users_response

List Steam users on device.

```json [Response payload]
{
  "users": [
    { "id": "76561198012345678", "name": "Gamer" }
  ]
}
```

### list_shortcuts / shortcuts_response

List shortcuts for a user.

```json [Request payload]
{ "userId": 76561198012345678 }
```

```json [Response payload]
{
  "shortcuts": [
    {
      "appId": 2857492837,
      "name": "Celeste",
      "exe": "/home/deck/Games/Celeste/Celeste.exe"
    }
  ]
}
```

### create_shortcut / operation_result

Create a Steam shortcut.

```json [Request payload]
{
  "userId": 76561198012345678,
  "shortcut": {
    "name": "Celeste",
    "exe": "/path/to/Celeste.exe",
    "startDir": "/path/to/game",
    "artwork": { "grid": "https://...", "hero": "https://..." }
  }
}
```

```json [Response payload]
{ "appId": 2857492837 }
```

### delete_shortcut / operation_result

Delete a shortcut.

```json [Request payload]
{
  "userId": "76561198012345678",
  "appId": 2857492837,
  "restartSteam": true
}
```

### apply_artwork / artwork_response

Apply artwork to existing shortcut.

```json [Request payload]
{
  "userId": "76561198012345678",
  "appId": 2857492837,
  "artwork": {
    "grid": "https://...",
    "hero": "https://...",
    "logo": "https://..."
  }
}
```

```json [Response payload]
{
  "applied": ["grid", "hero"],
  "failed": [{"type": "logo", "error": "download failed"}]
}
```

### restart_steam / steam_response

Restart Steam client.

```json [Response payload]
{ "success": true, "message": "Steam restarted" }
```

## File Upload Messages

### init_upload / upload_init_response

Initialize upload session.

```json [Request payload]
{
  "config": {
    "gameName": "Celeste",
    "installPath": "/home/deck/Games",
    "executable": "Celeste.exe"
  },
  "totalSize": 1234567890,
  "files": [
    { "relativePath": "Celeste.exe", "size": 12345 },
    { "relativePath": "data/game.pak", "size": 1234555545 }
  ]
}
```

```json [Response payload]
{
  "uploadId": "upload-abc123",
  "chunkSize": 1048576
}
```

### Binary Chunks

Sent as binary WebSocket messages:

```
[4-byte header length][JSON header][binary data]
```

JSON header:
```json
{
  "id": "msg-id",
  "uploadId": "upload-abc123",
  "filePath": "data/game.pak",
  "offset": 0,
  "checksum": "sha256..."
}
```

### upload_chunk_response
:badge[Agent → Hub]{type="info"}

Acknowledgment after each chunk.

```json
{
  "uploadId": "upload-abc123",
  "bytesWritten": 1048576,
  "totalWritten": 52428800
}
```

### complete_upload / operation_result

Finalize upload, optionally create shortcut.

```json [Request payload]
{
  "uploadId": "upload-abc123",
  "createShortcut": true,
  "shortcut": {
    "name": "Celeste",
    "exe": "Celeste.exe",
    "artwork": { "grid": "...", "hero": "..." }
  }
}
```

```json [Response payload]
{
  "success": true,
  "path": "/home/deck/Games/Celeste",
  "appId": 2857492837
}
```

### cancel_upload

Cancel an active upload.

```json [Request payload]
{ "uploadId": "upload-abc123" }
```

## Push Events

Sent by Agent without request.

### upload_progress
:badge[Event]{type="success"}

Progress during upload.

```json
{
  "uploadId": "upload-abc123",
  "transferredBytes": 524288000,
  "totalBytes": 1234567890,
  "currentFile": "data/game.pak",
  "percentage": 42.5
}
```

### operation_event
:badge[Event]{type="success"}

General operation notifications.

```json
{
  "type": "install",
  "status": "complete",
  "gameName": "Celeste",
  "progress": 100,
  "message": "Installation complete"
}
```

Status values: `start`, `progress`, `complete`, `error`

## Error Codes

| Code | Meaning |
|------|---------|
| 400 | Bad Request |
| 401 | Unauthorized (pairing required) |
| 404 | Not Found |
| 406 | Connections blocked |
| 409 | Conflict (hub already connected) |
| 500 | Internal Error |
| 501 | Not Implemented |

## Timing

| Constant | Value |
|----------|-------|
| Ping Period | 5s |
| Pong Wait | 15s |
| Write Wait | 10s |
| Request Timeout | 30s |
| Max Message | 10MB |
| Chunk Size | 1MB |
